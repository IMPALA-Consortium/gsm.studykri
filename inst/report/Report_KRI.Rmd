---
title: "Study KRI Comparison Report"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: flatly
params:
  lCharts: NA
  dfResults: NA
  dfGroups: NA
  dfMetrics: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)
library(dplyr)
library(ggplot2)
```

# Study-Level KRI Analysis

## Overview

This report presents Key Risk Indicators (KRIs) calculated at the study level compared against a portfolio comparison group.

```{r summary}
if (!is.null(params$dfResults) && nrow(params$dfResults) > 0) {
  summary_stats <- params$dfResults %>%
    group_by(StudyID, MetricID) %>%
    summarize(
      `Latest Month` = max(StudyMonth, na.rm = TRUE),
      `Latest Value` = Metric[which.max(StudyMonth)],
      .groups = 'drop'
    )
  
  knitr::kable(
    summary_stats,
    caption = "Summary of Latest KRI Values by Study",
    digits = 3
  )
}
```

## Charts

Below are the KRI charts for each study-metric combination.

```{r charts, results='asis', fig.width=10, fig.height=6}
if (!is.null(params$lCharts) && length(params$lCharts) > 0) {
  
  for (chart_name in names(params$lCharts)) {
    # Parse study ID and metric ID from chart name (format: "STUDYID_METRICID")
    parts <- strsplit(chart_name, "_")[[1]]
    if (length(parts) >= 2) {
      study_id <- parts[1]
      metric_id <- paste(parts[-1], collapse = "_")
      
      # Get metric name from dfMetrics if available
      metric_name <- metric_id
      if (!is.null(params$dfMetrics) && "MetricID" %in% names(params$dfMetrics)) {
        metric_row <- params$dfMetrics[params$dfMetrics$MetricID == metric_id, ]
        if (nrow(metric_row) > 0 && "Metric" %in% names(metric_row)) {
          metric_name <- metric_row$Metric[1]
        }
      }
      
      # Print section header
      cat(sprintf("\n### %s - %s\n\n", study_id, metric_name))
      
      # Print the chart
      print(params$lCharts[[chart_name]])
      
      cat("\n\n")
    }
  }
} else {
  cat("\nNo charts available.\n")
}
```

## Metrics Metadata

```{r metrics}
if (!is.null(params$dfMetrics) && nrow(params$dfMetrics) > 0) {
  knitr::kable(
    params$dfMetrics,
    caption = "KRI Metrics Definitions"
  )
}
```

---

*Report generated by gsm.studykri package*

